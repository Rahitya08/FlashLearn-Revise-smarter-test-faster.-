{% extends "layout.html" %}

{% block title %}
Study Deck
{% endblock %}

{% block main %}
<div class="container py-4">

    <!-- Logged in info + logout -->
    {% if user %}
    <div class="d-flex justify-content-end mb-3">
        <span class="me-2">Logged in as {{ user }}</span>
        <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
    {% endif %}

    <h3 class="mb-4">Study: {{ deck_name }}</h3>

    <!-- Live progress -->
    <div class="mb-3">
        <span>Correct: <strong id="liveCorrect">0</strong></span>
        <span class="ms-3">Incorrect: <strong id="liveIncorrect">0</strong></span>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <!-- Card display -->
            <div id="cardContainer"></div>

            <!-- Action buttons -->
            <div class="mt-3 d-flex justify-content-between" id="actionButtons">
                <button class="btn btn-success" id="correctBtn">Correct</button>
                <button class="btn btn-danger" id="incorrectBtn">Incorrect</button>
            </div>

            <!-- Result summary -->
            <div class="mt-3" id="resultSummary" style="display:none;">
                <h5>Quiz Finished!</h5>
                <p>Total Correct: <span id="totalCorrect"></span></p>
                <p>Total Incorrect: <span id="totalIncorrect"></span></p>
                <div class="d-flex gap-2 mt-3">
                    <a href="/" class="btn btn-primary">Home / Decks</a>
                    <a href="/logout" class="btn btn-outline-danger">Logout</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Shuffle cards randomly
let cards = {{ cards|tojson }};
cards = cards.sort(() => Math.random() - 0.5);

let currentCardIndex = 0;
let correctCount = 0;
let incorrectCount = 0;

const cardContainer = document.getElementById("cardContainer");
const correctBtn = document.getElementById("correctBtn");
const incorrectBtn = document.getElementById("incorrectBtn");
const resultSummary = document.getElementById("resultSummary");
const totalCorrect = document.getElementById("totalCorrect");
const totalIncorrect = document.getElementById("totalIncorrect");
const liveCorrect = document.getElementById("liveCorrect");
const liveIncorrect = document.getElementById("liveIncorrect");

function showCard(index) {
    // Quiz finished
    if (index >= cards.length) {
        cardContainer.style.display = "none";
        document.getElementById("actionButtons").style.display = "none";
        resultSummary.style.display = "block";
        totalCorrect.innerText = correctCount;
        totalIncorrect.innerText = incorrectCount;
        return;
    }

    const card = cards[index];
    cardContainer.innerHTML = `
        <h5>Question ${index + 1} of ${cards.length}</h5>
        <p><strong>${card.ques}</strong></p>
        <div id="answerContainer" style="display:none;" class="mt-3">
            <p><strong>Answer:</strong> ${card.ans}</p>
        </div>
        <button id="showAnswerBtn" class="btn btn-outline-secondary mt-2">Show Answer</button>
    `;

    // Hide buttons initially
    document.getElementById("actionButtons").style.display = "none";

    // Show buttons only after showing answer and if not last card
    document.getElementById("showAnswerBtn").addEventListener("click", () => {
        document.getElementById("answerContainer").style.display = "block";

        if (index < cards.length - 1) {
            document.getElementById("actionButtons").style.display = "flex";
        } else {
            document.getElementById("actionButtons").style.display = "none";
        }
    });
}

// Event handlers
correctBtn.addEventListener("click", () => {
    correctCount++;
    liveCorrect.innerText = correctCount;
    currentCardIndex++;
    showCard(currentCardIndex);
});

incorrectBtn.addEventListener("click", () => {
    incorrectCount++;
    liveIncorrect.innerText = incorrectCount;
    currentCardIndex++;
    showCard(currentCardIndex);
});

// Initialize first card
showCard(currentCardIndex);
</script>
{% endblock %}
